name: Set up SSH and deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Install the ssh dependencies
        run: |
             mkdir -p ~/.ssh
             chmod 700 ~/.ssh
             sudo apt-get update -y && sudo apt-get install rsync openssh-client
             eval $(ssh-agent -s)
             echo -e "Host *\\n\\tStrictHostKeyChecking no\\n\\n" > ~/.ssh/config
             sudo chmod 400 oc-P7linux.pem
             cat oc-P7linux.pem
             cat oc-P7linux.pem | ssh-add -
             echo "35.180.190.64" > ~/.ssh/known_hosts
      - name: send the code on remote server
        run: |
          sudo chmod 600 oc-P7linux.pem
          rsync -avz -e "ssh -i oc-P7linux.pem" --exclude '.git/*' --exclude 'node_modules/*' --exclude '.env'  ./ ubuntu@35.180.190.64:/home/ubuntu/deploygitlabci            


