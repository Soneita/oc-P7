name: Set up SSH and deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Install the ssh dependencies
        run: |
             mkdir -p ~/.ssh
             chmod 700 ~/.ssh
             'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install rsync openssh-client -y )'
             eval $(ssh-agent -s)
             '[[ -f /.dockerenv ]] && echo -e "Host *\\n\\tStrictHostKeyChecking no\\n\\n" > ~/.ssh/config'
             chmod 400 "$SSH_PRIVATE_KEY"
             cat oc-P7linux.pem
             cat oc-P7linux.pem | ssh-add -
             echo "35.180.190.64" > ~/.ssh/known_hosts
      - name: send the code on remote server
        run: |
          chmod 600 oc-P7linux.pem
          rsync -avz -e "ssh -i oc-P7linux.pem" --exclude '.git/*' --exclude 'node_modules/*' --exclude '.env'  ./ ubuntu@35.180.190.64:/home/ubuntu/deploygitlabci            


